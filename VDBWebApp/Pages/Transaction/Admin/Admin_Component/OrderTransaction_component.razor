@using System.Text.Json
@using Blazored.LocalStorage
@using Radzen
@using Radzen.Blazor
@using Models
@using System.Globalization;
@using VDBWebApp.Pages.Transaction.Order.Order_Component


@inject ILocalStorageService LocalStorage // Jika Anda menggunakan Blazored.LocalStorage
@inject IJSRuntime JSRuntime // Jika perlu untuk JSInterop
@inject Services.OrderServices OrderService
@inject Services.CustomerServices CustomerService
@inject Services.GensetServices GensetService
@inject NavigationManager Navigation

<div class="container">
    <p class="text-muted mb-4">Customer Name: <strong>@personName</strong></p>
    <p class="text-muted mb-4">Order ID: <strong>@OrderCodeId</strong></p>
    <p class="text-muted mb-4">Payment Note: <strong>@paymentNote</strong></p>
    <hr />
    <h3>Order List</h3>
    @if (Status?.ToUpper() == "NEW" && usertype == "ADMIN" && OrderCodeId == "")      
    {
    <div class="d-flex justify-content-end mb-2 mt-2" style="gap: 10px;">
        <button class="btn btn-primary" @onclick="OnSearchClik">Add Product</button>
     </div>
    }

    else if (Status?.ToUpper() == "NEW" && usertype == "ADMIN" && OrderCodeId != "")
    {
        <div class="d-flex justify-content-end mb-2 mt-2" style="gap: 10px;">
            <button class="btn btn-primary" @onclick="OnSearchClik">Add Product</button>
        </div>
    }
    
    <!-- Display selected products -->
    <div class="product-order-grid">
        @if (orderListCustomers != null && orderListCustomers.Any())
        {

            <VDBWebApp.Pages.Transaction.Order.Order_Component.Product_order_grid productorders="@orderListCustomers"
                                                                                  OnEditClicked="HandleClicked"
                                                                                  OnDeleteClicked="HandleConfirmationDelete"
                                                                                  Status="@Status"
                                                                                  UserType="@usertype"
                                                                                  />

        }
        else if (loading)
        {
            <p class="loading-text">Loading data...</p>
        }
        else
        {
            <VDBWebApp.Pages.Transaction.Order.Order_Component.Product_order_grid productorders="@orderListCustomers"/>
        }
    </div>
    @if (Status?.ToUpper() == "NEW" && usertype == "ADMIN" && OrderCodeId == "")      
    {
        <!-- Button to open modal for selecting products -->
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-success" @onclick="(() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnChekOutClick), msgCheckout))">CheckOut</button>
        </div>
    }
    else if (Status?.ToUpper() == "NEW" && usertype == "ADMIN" && OrderCodeId != "")
    {
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-success" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnConfirmClick),msgConfirm)">Confirm Order</button>
            <button class="btn btn-outline-danger" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnCancelClick),msgCancel)">Cancel Order</button>
            <button class="btn btn-outline-primary" @onclick="OnSearchClik">Delivery Label</button>
        </div>
    }
    else if (usertype != "ADMIN" && (Status?.ToUpper() == "NEW" || Status?.ToUpper() == "PAYMENT") && OrderCodeId != "")
    {
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-outline-danger" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnCancelClick),msgCancel)">Cancel Order</button>
        </div>
    }

    else if (Status?.ToUpper()=="CANCELED" && OrderCodeId != "")
    {
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-outline-danger" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnReplicateClick),msgReplicate)">Replicate Order</button>
        </div>
    }

    else if (usertype?.ToUpper()=="ADMIN" && Status?.ToUpper()=="PAYMENT" && OrderCodeId != "")
    {
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-success" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnPaymentClick),msgPayment)">Confirm Payment</button>
            <button class="btn btn-outline-danger" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnCancelClick),msgCancel)">Cancel Order</button>
            <button class="btn btn-outline-primary" @onclick="OnLabelClick">Delivery Label</button>
            <button class="btn btn-outline-success" @onclick="OnInvoiceClick">Invoice</button>
        </div>
    }
    else if (usertype?.ToUpper() == "ADMIN" && Status?.ToUpper() == "PROCESS" && OrderCodeId != "")
    {
        <div class="d-flex mb-2" style="gap: 10px;">
            <button class="btn btn-success" @onclick="() => ShowSaveConfirmation(EventCallback.Factory.Create(this, OnClosedClick),msgClosed,btnClose1,btnClose2)">Close Order</button>
            <button class="btn btn-outline-primary" @onclick="OnLabelClick">Delivery Label</button>
            <button class="btn btn-outline-success" @onclick="OnInvoiceClick">Invoice</button>
        </div>
    }

    <hr />

    @if (personCategory == "DSM")
    {


        <div class="order-summary p-3 border rounded">
            <h4 class="text-center">Order Summary</h4>
            <p class="text-center order-status @GetOrderStatusClass(Status) mb-4 ">Status: <strong>@Status</strong></p>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Total Amount</label>
                    <input type="text" class="form-control" readonly @bind="orderSummary.SubTotal" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Total Quantity</label>
                    <input type="text" class="form-control" readonly @bind="orderSummary.TotalQty" />
                </div>
                @if (IsReadOnly)
                {
                    orderSummary.Disc = orderSummary.DiscDecimal.ToString("N2");
                    orderSummary.DeliveryCost = orderSummary.DeliveryCostDecimal.ToString("N2");
                    <div class="col-md-6">
                        <label class="form-label">Discount</label>
                        <input type="text" class=" form-control" readonly="@IsReadOnly"  @bind="orderSummary.Disc" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Delivery Cost</label>
                        <input type="text" class="form-control" readonly="@IsReadOnly" @bind="orderSummary.DeliveryCost" />
                    </div>
                }
                else
                {
                   
                <div class="col-md-6">
                    <label class="form-label">Discount</label>
                    <input type="number" class="form-control" readonly="@IsReadOnly"
                               step="0.01" min="0"
                    @bind="orderSummary.DiscDecimal" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Delivery Cost</label>
                    <input type="number" class="form-control"
                               step="0.01" min="0"
                    readonly="@IsReadOnly" @bind="orderSummary.DeliveryCostDecimal" />
                </div>
                }
                
                <div class="col-12">
                    <label class="form-label">Remark</label>
                    <InputTextArea class="form-control" readonly="@IsReadOnly" @bind-Value="orderSummary.Remark" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sender Store Name</label>
                    <div class="input-group mb-1">
                        <input type="text" class="form-control" readonly @bind="selectedStore.StoreName" />

                        <button class="btn btn-outline-secondary" disabled="@IsReadOnly" @onclick="OpenStoreLookupModal" type="button" title="Find Store">
                            <img src="images/material/search.png" alt="Lookup" style="width: 16px; height: 16px;" />
                        </button>
                    </div>
                    <input type="text" class="form-control mb-1" readonly @bind="selectedStore.StreetAddress" />
                    <input type="text" class="form-control mb-1" readonly @bind="selectedStore.PhoneNo" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Resi No</label>
                    <input type="text" class="form-control" readonly="@IsReadOnly" @bind="orderSummary.DeliveryReceiptNo" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Recipient Name</label>
                    <input type="text" class="form-control" readonly="@IsReadOnly" @bind="orderSummary.RecName" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Recipient Phone No</label>
                    <input type="text" class="form-control" readonly="@IsReadOnly" @bind="orderSummary.RecPhoneNo" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Recipient Address</label>
                    <div class="input-group mb-1">
                        <input type="text" class="form-control" readonly @bind="orderSummary.RecStreetAddress" />

                        <button class="btn btn-outline-secondary" disabled="@IsReadOnly" @onclick="OpenAddressLookupModal" type="button" title="Find Address">
                            <img src="images/material/search.png" alt="Lookup" style="width: 16px; height: 16px;" />
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Courier</label>
                    <div class="input-group mb-1">
                        <input type="text" class="form-control" readonly @bind="selectedGenset.Gname" />

                        <button class="btn btn-outline-secondary" disabled="@IsReadOnly" @onclick="OpenCourierLookupModal" type="button" title="Find Courier">
                            <img src="images/material/search.png" alt="Lookup" style="width: 16px; height: 16px;" />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {

        <div class="order-summary p-3 border rounded">
            <h4 class="text-center">Order Summary</h4>
            <p class="text-center order-status @GetOrderStatusClass(Status) mb-4 ">Status: <strong>@Status</strong></p>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Total Amount</label>
                    <input type="text" class="form-control" readonly @bind="orderSummary.SubTotal" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Total Quantity</label>
                    <input type="text" class="form-control" readonly @bind="orderSummary.TotalQty" />
                </div>
                @if (IsReadOnly)
                {
                    orderSummary.Disc = orderSummary.DiscDecimal.ToString("N2");
                    orderSummary.DeliveryCost = orderSummary.DeliveryCostDecimal.ToString("N2");
                    <div class="col-md-6">
                        <label class="form-label">Discount</label>
                        <input type="text" class=" form-control" readonly="@IsReadOnly"  @bind="orderSummary.Disc" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Delivery Cost</label>
                        <input type="text" class="form-control" readonly="@IsReadOnly"  @bind="orderSummary.DeliveryCost" />
                    </div>
                }
                else
                {
                    <div class="col-md-6">
                        <label class="form-label">Discount</label>
                        <input type="number" class="form-control" readonly="@IsReadOnly"
                               step="0.01" min="0"
                               @bind="orderSummary.DiscDecimal" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Delivery Cost</label>
                        <input type="number" class="form-control"
                               step="0.01" min="0"
                               readonly="@IsReadOnly" @bind="orderSummary.DeliveryCostDecimal" />
                    </div>
                }
                <div class="col-12">
                    <label class="form-label">Remark</label>
                    <InputTextArea class="form-control" readonly="@IsReadOnly" @bind-Value="orderSummary.Remark" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Recipient Address</label>
                    <div class="input-group mb-1">
                        <input type="text" class="form-control" readonly @bind="selectedStore.StoreName" />

                   </div>
                    <input type="text" class="form-control mb-1" readonly @bind="selectedStore.StreetAddress" />
                    <input type="text" class="form-control mb-1" readonly @bind="selectedStore.PhoneNo" />
                </div>
            </div>
        </div>
    }

</div>
@if (isLoading)
{
    <ProgressCart LoadingImageUrl="images/material/cart_add_gif.gif" />
}

@if (showSearchProductModal)
{
    <VDBWebApp.Pages.Transaction.Order.Order_Component.Search_order OnModalClosed="CloseLookupModal"
                                                                    OnCartClicked="HandleSelectedCart" />
}

@if (openAddressModal)
{
    <AddressLookupModal OnAddressSelected="HandleAddressSelected"
                        OnModalClosed="CloseAddressLookupModal"
                        AddressCodeSeq="@orderSummary.RecAddressCode"
                        AddressAlamat="@orderSummary.RecStreetAddress" />

}
@if (openCourierModal)
{
    <div class="modal fade show" tabindex=" -1" role="dialog" style="display:block;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content p-4">
                <div class="modal-header">
                    <h5 class="modal-title">Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="CloseCourierModal"></button>
                </div>

                <div class="table-container mt-2">
                    <div class="table-header-actions">
                    </div>
                    <table class="table table-striped table-bordered table-hover person-table">
                        <thead class="table-header">
                            <tr>
                                <th>No</th>
                                <th>Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Gensets != null && Gensets.Any())
                            {
                                int seq = 1;
                                @foreach (var store in Gensets)
                                {

                                    <tr>
                                        <td>@seq</td>
                                        <td>@store.Gname</td>
                                        <td>
                                            <div class="d-flex mb-2" style="gap: 10px;">
                                                <button class="btn btn-secondary" @onclick="() => SetCourier(store)">Choose</button>
                                            </div>
                                        </td>
                                    </tr>
                                    seq++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center">Data tidak tersedia</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseStoreModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}


@if (openStoreModal)
{
    <div class="modal fade show" tabindex=" -1" role="dialog" style="display:block;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content p-4">
                <div class="modal-header">
                    <h5 class="modal-title">Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="CloseStoreModal"></button>
                </div>

                <div class="table-container mt-2">
                    <div class="table-header-actions">
                    </div>
                    <table class="table table-striped table-bordered table-hover person-table">
                        <thead class="table-header">
                            <tr>
                                <th>No</th>
                                <th>Store Name</th>
                                <th>Store Address</th>
                                <th>Phone No</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (customersstore != null && customersstore.Any())
                            {
                                int seq = 1;
                                @foreach (var store in customersstore)
                                {

                                    <tr>
                                        <td>@seq</td>
                                        <td>@store.StoreName</td>
                                        <td>@store.StreetAddress</td>
                                        <td>@store.PhoneNo</td>
                                        <td>
                                            <div class="d-flex mb-2" style="gap: 10px;">
                                                <button class="btn btn-secondary" @onclick="() => SetStore(store)">Choose</button>
                                            </div>
                                        </td>
                                    </tr>
                                    seq++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center">Data tidak tersedia</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseStoreModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}


@if (showEditQty)
{

    <div class="modal fade show" tabindex=" -1" role="dialog" style="display:block;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="CloseEditQtyModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="Quantity" class="form-label">Quantity</label>
                        <InputNumber id="Quantity" class="form-control" @bind-Value="selectedOrderListCustomer.QtyNum" />
                    </div>
                    <div class="mb-3">
                        <label for="Remark" class="form-label">Remark</label>
                        <InputTextArea id="Remark" class="form-control" @bind-Value="selectedOrderListCustomer.Remark" />
                        <button type="button" class="btn btn-success mt-5" data-bs-dismiss="modal" @onclick="SaveEditQty">Save</button>
                    </div>
                    <hr />
                    <div class="mb-3">
                        <label for="DiscPercent" class="form-label">Discount By Percentage (%)</label>
                        <InputNumber id="DiscPercent" class="form-control" @bind-Value="discPercent" />
                        <button type="button" class="btn btn-success mt-5" data-bs-dismiss="modal" @onclick="SaveEditDiscPercent">Save Percentage</button>
                    </div>
                    <hr />
                    <div class="mb-3">
                        <label for="DiscAmount" class="form-label">Discount By Amount</label>
                        <InputNumber id="DiscAmount" class="form-control" @bind-Value="discAmount" />
                        <button type="button" class="btn btn-success mt-5" data-bs-dismiss="modal" @onclick="SaveEditDiscAmount">Save Amount</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseEditQtyModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}



<ActionModal @ref="SaveConfirmationModal" />
<WarningModal @ref="warningModal" />

@if (isLoadingMenu)
{
    <ProgressCircle LoadingImageUrl="images/logoVDB.png" />
}
@code {

    [Parameter]
    public string? Status { get; set; }

    [Parameter]
    public string? usertype { get; set; }

    [Parameter]
    public string? OrderCodeId { get; set; }

    private bool IsReadOnly =>
    (Status ?? "NEW").ToUpper() != "NEW" ||
    ((Status ?? "NEW").ToUpper() == "NEW" && (usertype?.ToUpper() != "ADMIN"));

    private string msgCheckout = "Are you sure to check out?";
    private string msgConfirm = "Are you sure to confirm this order?";
    private string msgCancel = "Are you sure to cancel this order?";
    private string msgClosed = "Are you sure to close this order?";
    private string msgPayment = "Are you sure to confirm this payment?";
    private string msgReplicate = "All orders will be copied to a new transaction, and the entire cart list will be cleared. Are you sure you want to proceed?";

    private string btnClose1= "Submit";
    private string btnClose2 = "Cancel";

    private Order orderSummary = new();

    private OrderListCustomers selectedOrderListCustomer = new OrderListCustomers();
    private List<CustomerStore> customersstore = new();
    private CustomerStore selectedStore = new();
    private ActionModal? SaveConfirmationModal;
    private WarningModal warningModal;
    private List<Genset> Gensets = new List<Genset>();
    private Genset selectedGenset = new();
    private string gtypepar = "02";

    private bool loading = false;
    private bool isLoading = false;

    private bool isLoadingMenu = false;
    private bool showSearchProductModal = false;
    private bool showEditQty = false;
    private bool openStoreModal = false;
    private bool openAddressModal = false;
    private bool openCourierModal = false;
    private bool openLabelPdf = false;
    private bool openInvPdf = false;

    private string customerpersonid = "";
    private string userid = "";
    private string itemIdCartToRemove = "";
    private string orderid = "";
    private decimal discPercent = 0;
    private decimal discAmount = 0;
    private string personName = "";
    private string personCategory = "";
    private string paymentNote = "";
    private int qtyPrev = 0;
    private string? PdfUrl;

    private List<OrderListCustomers> orderListCustomers = new List<OrderListCustomers>();
    private OrderCustomer customer = new OrderCustomer();
    private Response response = new Response();

    private int TotalQty => orderListCustomers.Sum(x => x.QtyNum);

    protected override async Task OnInitializedAsync()
    {
        isLoadingMenu = true;
        await FetchData();
        isLoadingMenu = false;
    }

    private async Task FetchData()
    {

        customerpersonid = await LocalStorage.GetItemAsync<string>("selectedOrderCustomerId");
        personName = await LocalStorage.GetItemAsync<string>("personname") ?? "";
        personCategory = await LocalStorage.GetItemAsync<string>("personcategory") ?? "";
        paymentNote = await LocalStorage.GetItemAsync<string>("paymentnote") ?? "";
        userid = await LocalStorage.GetItemAsync<string>("userid") ?? "";




        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var data = await OrderService.GetListTransactionOrderDetail(OrderCodeId);
        var dataheader = await OrderService.GetListTransactionOrderHeader(OrderCodeId);

        var datastore = await CustomerService.GetCustomerStore(customerpersonid);
        var datacourier = await GensetService.GetGenset(gtypepar, "0", "1", "");

        @*if (Status == "NEW")
        {
            var dataorder = await OrderService.GetListReplicateTransactionOrderDetail(OrderCodeId, customerpersonid);
        }*@


        if (!string.IsNullOrEmpty(data))
        {
            orderListCustomers = JsonSerializer.Deserialize<List<OrderListCustomers>>(data, options) ?? new List<OrderListCustomers>();

        }

        if (!string.IsNullOrEmpty(dataheader))
        {
            orderSummary = JsonSerializer.Deserialize<List<Order>>(dataheader, options).FirstOrDefault() ?? new();

        }



        if (!string.IsNullOrEmpty(datastore))
        {
            customersstore = JsonSerializer.Deserialize<List<CustomerStore>>(datastore, options);

            if (personCategory == "DSM")
            { selectedStore = customersstore.FirstOrDefault(s => s.StoreId == orderSummary.SenderStoreId); }
            else
            { selectedStore = customersstore.FirstOrDefault(s => s.StoreId == orderSummary.RecStoreId); }
        }

        if (!string.IsNullOrEmpty(datacourier))
        {
            Gensets = JsonSerializer.Deserialize<List<Genset>>(datacourier, options);
        }


        orderSummary.SubTotal = orderListCustomers.Sum(x => x.SubTotalAmount).ToString("N2");
        orderSummary.TotalQty = orderListCustomers.Sum(x => x.QtyNum).ToString();

    }

    private async Task CloseLookupModal()
    {
        await FetchData();
        showSearchProductModal = false;
    }

    private async Task SaveEditQty()
    {
        //var data = OrderService.SetQtyCart(customerpersonid, selectedOrderListCustomer.Item_Id, selectedOrderListCustomer.Qty);

        var data = await OrderService.SetQtyOrder(OrderCodeId, selectedOrderListCustomer.Item_Id, selectedOrderListCustomer.Qty, selectedOrderListCustomer.Remark);
        Console.WriteLine(data);
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show("Data successfully saved", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan sukses

                showEditQty = false;
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
                
            }
        }

    }

    private async Task SaveEditDiscPercent()
    {
        //var data = OrderService.SetQtyCart(customerpersonid, selectedOrderListCustomer.Item_Id, selectedOrderListCustomer.Qty);

        var data = await OrderService.SetDiscPercentageOrder(OrderCodeId, selectedOrderListCustomer.Item_Id, discPercent.ToString("F2"));
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show("Data successfully saved", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan sukses
                Console.WriteLine("Update Success");
                discPercent = 0;
                showEditQty = false;
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
               

            }
        }

    }

    private async Task SaveEditDiscAmount()
    {
        //var data = OrderService.SetQtyCart(customerpersonid, selectedOrderListCustomer.Item_Id, selectedOrderListCustomer.Qty);

        var data = await OrderService.SetDiscAmountOrder(OrderCodeId, selectedOrderListCustomer.Item_Id, discAmount.ToString("F2"));
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show("Data successfully saved", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan sukses
                
                discAmount = 0;
                showEditQty = false;
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, NoConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
               
            }
        }
    }

    private void SuccessConfirmation()
    {
        Navigation.NavigateTo("/home");
    }

    private async Task NoConfirmation()
    {
        await FetchData();
    }

    private void SuccessConfirmationCheckout()
    {
        if (personCategory == "DSM")
        {
            Navigation.NavigateTo("/productetalase");
        }
        else
        {
            Navigation.NavigateTo("/home");
        }
    }

    private async Task HandleConfirmationDelete(OrderListCustomers orderListCustomer)
    {
        ShowSaveConfirmation(
    EventCallback.Factory.Create(this, async () => await HandleRemoveItemCart(orderListCustomer)),
    "Are you sure you want to remove this item?");
    }

    private async Task HandleRemoveItemCart(OrderListCustomers orderListCustomer)
    {
        var data = await OrderService.DeleteItemFromOrder(OrderCodeId, orderListCustomer.Item_Id);
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show("Success, Data has been removed from list", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);
                // Tampilkan pesan sukses
                
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
                
            }
        }
        await FetchData();
    }


    private void HandleClicked(OrderListCustomers orderListCustomer)
    {
        selectedOrderListCustomer = orderListCustomer;
        qtyPrev = orderListCustomer.QtyNum;
        showEditQty = true;
        
    }


    private async Task CloseEditQtyModal()
    {
        showEditQty = false;
        Navigation.NavigateTo(Navigation.Uri);
        await FetchData();
        StateHasChanged();
    }


    private async Task HandleSelectedCart(Product prd)
    {
        var data = await OrderService.AddItemToCart(customerpersonid, prd.item_id);
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show("Success inserted to List", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);
                // Tampilkan pesan sukses
               
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
                
            }
        }
        await FetchData();
    }

    private void HandleAddressSelected(Address selectedAddress)
    {
        orderSummary.RecAddressCode = selectedAddress.AddressCode;
        orderSummary.RecStreetAddress = selectedAddress.AlamatLengkap;

        openAddressModal = false;
        StateHasChanged();
    }

    private void CloseAddressLookupModal()
    {
        openAddressModal = false;
    }

    private void OnSearchClik()
    {
        showSearchProductModal = true;
    }

    private async Task OnChekOutClick()
    {


        if (personCategory == "DSM")
        {
            orderSummary.SenderAddressCode = selectedStore.AddressCode;
            orderSummary.SenderStoreId = selectedStore.StoreId;
            orderSummary.SenderName = selectedStore.StoreName;
            orderSummary.SenderStreetAddress = selectedStore.StreetAddress;
            orderSummary.SenderPhoneNo = selectedStore.PhoneNo;
        }
        else
        {
            orderSummary.RecAddressCode = selectedStore.AddressCode;
            orderSummary.RecStoreId = selectedStore.StoreId;
            orderSummary.RecName = selectedStore.StoreName;
            orderSummary.RecStreetAddress = selectedStore.StreetAddress;
            orderSummary.RecPhoneNo = selectedStore.PhoneNo;
        }

        orderSummary.ItemList = "";
        orderSummary.CourierCode = selectedGenset.GCode;

        foreach (var prod in orderListCustomers)
        {
            orderSummary.ItemList = orderSummary.ItemList +
                                    prod.Item_Id + ";" + prod.PriceNum.ToString() + ";" +
                                    prod.DiscAmount.ToString("F2") + ";" + prod.QtyNum.ToString("F0") + ";*";
        }

        var data = await OrderService.SetOrderInsertSO(customerpersonid, userid, orderSummary);
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };

        if (!string.IsNullOrEmpty(data))
        {
            response = JsonSerializer.Deserialize<List<Response>>(data, options).FirstOrDefault() ?? new Response();

            if (response.StatusCode == "200")
            {
                if (string.IsNullOrEmpty(OrderCodeId))
                {
                    isLoadingMenu = true;
                    isLoadingMenu = false;
                    SaveConfirmationModal?.Show($"Success, order created with number : {response.DocNo}", "bi bi-check-circle", 0, EventCallback.Factory.Create(this, SuccessConfirmationCheckout), "Ok", false);
                    // Tampilkan pesan sukses
                    
                } 
            }
            else
            {
                isLoadingMenu = true;
                isLoadingMenu = false;
                SaveConfirmationModal?.Show(response.Msg, "bi bi-exclamation-triangle", 1, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);
                // Tampilkan pesan error
                selectedOrderListCustomer.QtyNum = qtyPrev;
                
            }
        }

        @*Console.WriteLine(userid);
        Console.WriteLine(customerpersonid);
        Console.WriteLine(string.Join(", ", orderSummary.GetType()
     .GetProperties()
     .Select(p => $"{p.Name}: {p.GetValue(orderSummary)}")));*@

    }

    private async Task OnConfirmClick()
    {

        OnChekOutClick();

        var data = await OrderService.SetStatusOrder(OrderCodeId,customerpersonid, "PAYMENT");

        SaveConfirmationModal?.Show($"Success, Order has been confirmed", "bi bi-exclamation-triangle", 2, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);

    }

    private async Task OnPaymentClick()
    {
        var data = await OrderService.SetStatusOrder(OrderCodeId, customerpersonid, "PROCESS");

        SaveConfirmationModal?.Show($"Success, Payment has beed confirmed", "bi bi-exclamation-triangle", 2, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);

    }

    private async Task OnCancelClick()
    {
        var data = await OrderService.SetStatusOrder(OrderCodeId, customerpersonid, "CANCELED");

        SaveConfirmationModal?.Show($"Success, Order has been Canceled", "bi bi-exclamation-triangle", 2, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);

    }

    private async Task OnReplicateClick()
    {
        var dataorder = await OrderService.GetListReplicateTransactionOrderDetail(OrderCodeId, customerpersonid);

        SaveConfirmationModal?.Show($"Success, Order has been Replicated", "bi bi-exclamation-triangle", 2, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);

    }

    private async Task OnClosedClick()
    {
        var data = await OrderService.SetStatusOrder(OrderCodeId, customerpersonid, "CLOSED");

        SaveConfirmationModal?.Show($"Success, Order has been Closed", "bi bi-exclamation-triangle", 2, EventCallback.Factory.Create(this, SuccessConfirmation), "Ok", false);

    }

    private async Task OnInvoiceClick ()
    {
        var data = await OrderService.GetFileReport(OrderCodeId, "INV", "PDF");

        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var result = JsonSerializer.Deserialize<List<FileImage>>(data, options);
        var base64 = result?.FirstOrDefault()?.FileImages;


        if (!string.IsNullOrEmpty(base64))
        {

            await JSRuntime.InvokeVoidAsync("downloadBase64File", base64, $"Invoice_{OrderCodeId}.pdf");
        }
    }

    private async Task OnLabelClick()
    {
        var data = await OrderService.GetFileReport(OrderCodeId, "SLIP", "PDF");

        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var result = JsonSerializer.Deserialize<List<FileImage>>(data, options);
        var base64 = result?.FirstOrDefault()?.FileImages;


        if (!string.IsNullOrEmpty(base64))
        {
            
            await JSRuntime.InvokeVoidAsync("downloadBase64File", base64, $"DeliveryLabel_{OrderCodeId}.pdf");
        }
        
    }


    @*  private void AddToCart(Product product)
    {
        selectedProducts.Add(product);
    }

    private void AddToWishlist(Product product)
    {
        wishlist.Add(product);
    }*@

    private void CloseStoreModal()
    {
        openStoreModal = false;
    }

    private void CloseCourierModal()
    {
        openCourierModal = false;

    }

    private void OpenStoreLookupModal()
    {
        openStoreModal = true;
    }

    private void OpenCourierLookupModal()
    {
        openCourierModal = true;
    }

    private void OpenAddressLookupModal()
    {
        openAddressModal = true;
    }

    private async Task SetStore(CustomerStore store)
    {
        selectedStore = store;
        openStoreModal = false;
    }

    private async Task SetCourier(Genset genset)
    {
        selectedGenset = genset;
        openCourierModal = false;
    }

    private async Task ShowSaveConfirmation(EventCallback confirmAction, string? msg = null, string? msgYes = null, string? msgNo = null)
    {
        var message = string.IsNullOrWhiteSpace(msg)
            ? "Apakah Anda yakin ingin Menyimpan?"
            : msg;
        var messageYes = string.IsNullOrWhiteSpace(msgYes)
            ? "Yes"
            : msgYes;
        var messageNo = string.IsNullOrWhiteSpace(msgNo)
        ? "No"
        : msgNo;

        SaveConfirmationModal?.Show(
            message,                     // gunakan msg atau default
            "oi oi-warning",             // icon
            2,                           // level
            confirmAction,               // EventCallback dinamis
            messageYes,                  // confirm button label
            true,                        // show cancel
            messageNo                     // cancel button label
        );
    }

    private string GetOrderStatusClass(string status)
    {
        return status?.ToUpper() switch
        {
            "NEW" => "order-status",
            "PAYMENT" => "order-status-payment",
            "PROCESS" => "order-status-process",
            "CANCELED" => "order-status-canceled",
            "CLOSED" => "order-status-closed",
            _ => "order-status-default", // Class default jika status tidak dikenali
        };
    }


}
